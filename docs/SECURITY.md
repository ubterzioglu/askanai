# Security Model

This project follows: **"Frontend open olsa bile sistem kirilmasin."**

## Threat Model

- Client is **untrusted**:
  - Body/header/query/localStorage/JS runtime can be manipulated.
  - Requests can be replayed.
- Therefore:
  - Rate limits, give-to-get, ownership, dedupe and moderation throttles are enforced server-side (Vercel API) and/or DB-side (constraints/RLS).

## DTO Rules (Public vs Internal)

Public responses (what the browser can read) must not include:

- `user_id`
- `ip_hash`
- `fingerprint`
- `reported_by_user_id`
- `abuse_signals.*`
- any archived fields/data

Enforcement:

- Public read paths are only via:
  - `polls_public` view
  - `comments_public` view
  - non-sensitive tables `questions` / `options` (RLS-gated)
- Sensitive columns are protected even if a table becomes readable by mistake:
  - `REVOKE SELECT (...)` on sensitive columns for `anon` and `authenticated`
  - see `supabase/migrations/20260209223000_security_hardening_v1.sql`

## Backend-Enforced Rules (Vercel /api)

### Auth requirement (server-side)

- This app is intentionally anonymous-first. However, when the user *is* logged in, the API binds actions to `user_id` for dedupe/rate limiting.
- Admin actions remain Supabase-auth + RLS protected.

### Give-to-get (content gating)

`visibility_mode = voters`:

- `GET /api/polls/:pollId/results` returns `403 GIVE_TO_GET_REQUIRED` unless:
  - user has responded (by `user_id` if logged-in, otherwise by `ip_hash`), or
  - user is owner/admin

### Ownership

Owner is defined as:

- authenticated owner: `poll.created_by_user_id == auth.uid()`
- anonymous owner: `sha256(creatorKey) == poll.creator_key_hash`

The API supports anonymous ownership via `x-creator-key` header for owner-only operations.

Delete/Archive:

- `DELETE /api/polls/:pollId/delete` performs an ownership check and then calls a DB function to archive + delete transactionally (`public.archive_poll`).

### Duplicate prevention (DB-level)

Enforced via unique indexes:

- one response per poll per `user_id` (authenticated)
- one response per poll per `ip_hash` (anonymous)
- one answer per (response, question)
- duplicate comment/ticket text from same ip on same target via `text_hash`

See migration:

- `supabase/migrations/20260209223000_security_hardening_v1.sql`

### Rate limiting & abuse

- Enforced only in backend API (not in the browser UX).
- Server derives:
  - `ip_hash = sha256(IP_HASH_SALT | ip)`
  - `user_agent_hash = sha256(IP_HASH_SALT | user-agent)`
- A write creates an `abuse_events` record; counts in 1h / 24h / 7d windows block excessive usage.

Implementation:

- `api/_lib/rateLimit.ts`
- `public.abuse_events` table (RLS-denied to public)

### Moderation / report throttle

- `POST /api/polls/:pollId/report` is rate-limited (`ticket_create`)
- Tickets are admin-only readable; the public client cannot read tickets

## DB/RLS Summary

Target behavior:

- Public:
  - polls: readable for non-private open/closed polls (sensitive columns revoked)
  - comments: readable only if `status = visible` (via view)
  - questions/options: readable only when parent poll is accessible
- Non-public:
  - responses/answers/tickets/poll_views: not directly writable by public client; read restricted to admins

## Frontend Security

- No `SERVICE_ROLE_KEY` is present in the client bundle.
- User-generated text is rendered as plain text (no `dangerouslySetInnerHTML`).
- "Client-side validation" is UX only; server-side is authoritative.

## CORS / Origin / Headers

- Vercel API:
  - uses origin allowlist via `ALLOWED_ORIGINS` (see `api/_lib/security.ts`)
- Supabase Edge Function:
  - uses `ALLOWED_ORIGINS` allowlist (see `supabase/functions/send-confirmation-email/index.ts`)
- Security headers:
  - configured in `vercel.json` (CSP, nosniff, clickjacking, referrer policy)

## Storage (Preview Images)

- Bucket: `poll-images` is public-read.
- Anonymous uploads are disabled in DB policies.
- Browser uploads use a **signed upload token** generated by backend:
  - `POST /api/storage/poll-image-signed-upload`
